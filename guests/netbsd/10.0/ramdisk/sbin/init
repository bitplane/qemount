#!/bin/sh
export PATH=/bin:/sbin

on_exit() {
    echo "[INIT] Shutting down..."
    # exec replaces the process so we never return
    exec halt -p
}
trap on_exit EXIT

# Mount tmpfs at /dev so we can create device nodes
mount -t tmpfs tmpfs /dev

# Create device nodes
# console=0,0  tty00/com0=8,0  null=2,2
# wd*=0,*  (IDE disks: wd0a=0,0  wd1a=0,8 - minor = unit*8 + partition)
# sd*=4,*  (SCSI/virtio: sd0a=4,0)
# ld*=19,* (virtio-blk: ld0a=19,0)
mknod /dev/console c 0 0
mknod /dev/tty00 c 8 0
mknod /dev/null c 2 2
mknod /dev/wd0a b 0 0
mknod /dev/wd1a b 0 8
mknod /dev/sd0a b 4 0
mknod /dev/ld0a b 19 0

# Redirect to serial console
exec >/dev/tty00 2>&1 </dev/tty00

echo ""
echo "==================================="
echo "  NetBSD qemount guest starting"
echo "==================================="
echo ""

# Mount point for user's image
MOUNT_POINT=/mnt
MOUNT_SUCCESS=0

# Try different possible devices for the user's image
for TARGET_DEV in /dev/ld0a /dev/sd0a /dev/wd1a; do
    echo "[INIT] Trying $TARGET_DEV..."
    if mount "$TARGET_DEV" "$MOUNT_POINT" 2>/dev/null; then
        MOUNT_SUCCESS=1
        echo "[INIT] Mounted $TARGET_DEV to $MOUNT_POINT"
        break
    fi
done

if [ "$MOUNT_SUCCESS" = "0" ]; then
    echo "[INIT] No mountable image found"
fi

export MOUNT_SUCCESS
export MOUNT_POINT

# Detect mode - check for virtio serial device
if [ -c /dev/vport0p1 ]; then
    MODE="9p"
else
    MODE="sh"
fi

SCRIPT="/init.${MODE}"

echo "[INIT] Dispatching to: $SCRIPT"
if [ -x "$SCRIPT" ]; then
    "$SCRIPT" || echo "[INIT] Script failed: $?"
else
    echo "[INIT] Mode script not found: $SCRIPT"
    /bin/sh -i
fi

# Script exited - trap will handle shutdown
