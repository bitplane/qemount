#!/bin/sh
set -eu

on_exit() {
    echo "[INIT] Shutting down..."
    sync
    umount -a 2>/dev/null || true
    sync
    poweroff -f || true
    sleep 1
    poweroff -f || true
    sleep infinity
}
trap on_exit EXIT

PORT_PATH=/dev/hvc0

mountpoint -q /dev  || mount -t devtmpfs devtmpfs /dev
mountpoint -q /proc || mount -t proc none /proc
mountpoint -q /sys  || mount -t sysfs none /sys
mount -t tmpfs tmpfs /tmp
mount -t tmpfs tmpfs /mnt
cp -a /etc /tmp/etc
mount -t tmpfs tmpfs /etc
mv /tmp/etc/* /etc/

# run mdev to detect devices
mdev -sS

# Hold fd open so stty options persist - device resets to echo mode on close
# May fail on older kernels without virtio-serial, so don't abort
if [ -e "$PORT_PATH" ]; then
    exec 3<>"$PORT_PATH" 2>/dev/null || true
    stty -F "$PORT_PATH" raw -echo -echoe -echok -echoctl 2>/dev/null || true
fi

printf '\e[?7h'  # re-enable line wrap (disabled by seabios)

echo ""
echo "==================================="
echo "  Linux qemount guest starting"
echo "==================================="
echo ""

# Try to mount dev to /mnt/name. Creates dir, mounts, cleans up on failure.
# Usage: try_mount /dev/vdb1 b1
# Returns 0 on success, 1 on failure
try_mount() {
    dev="$1"
    name="$2"
    mnt="/mnt/${name}"
    mkdir -p "$mnt"
    # Try auto first, then explicit types that auto-detect doesn't always try
    for fstype in auto sysv v7 hfs coherent xenix; do
        if mount -t "$fstype" "$dev" "$mnt" 2>/dev/null; then
            echo "[INIT] Mounted $dev -> $mnt ($fstype)"
            return 0
        fi
    done
    rmdir "$mnt" 2>/dev/null || true
    return 1
}

echo "[INIT] Scanning for disk images..."

MOUNT_SUCCESS=0

# Iterate through possible virtio disks (vdb, vdc, vdd, ...)
# vda is rootfs, so user disks start at vdb
for vd in /dev/vd[b-z]; do
    [ -b "$vd" ] || continue
    letter="${vd#/dev/vd}"

    # Check for partitions first
    has_partitions=0
    for part in ${vd}[0-9]*; do
        [ -b "$part" ] || continue
        has_partitions=1
        num="${part#${vd}}"
        if try_mount "$part" "${letter}${num}"; then
            MOUNT_SUCCESS=1
        fi
    done

    # If no partitions, try whole disk
    if [ "$has_partitions" = "0" ]; then
        if try_mount "$vd" "$letter"; then
            MOUNT_SUCCESS=1
        fi
    fi
done

if [ "$MOUNT_SUCCESS" = "0" ]; then
    echo "[INIT] No mountable images found"
fi

MOUNT_POINT=/mnt
export MOUNT_SUCCESS="$MOUNT_SUCCESS"
export MOUNT_POINT="$MOUNT_POINT"
export PORT_PATH="$PORT_PATH"

MODE=$(sed -n 's/.*mode=\([^ ]*\).*/\1/p' /proc/cmdline)
SCRIPT="/sbin/init.${MODE:-sh}" 

echo "root:password" | chpasswd

echo "[INIT] Dispatching to: $SCRIPT"
"$SCRIPT"
rc=$?
if [ "$rc" -ne 0 ]; then
    echo "[INIT] Script failed: $rc"
    /bin/sh
fi

# EXIT trap handles shutdown
